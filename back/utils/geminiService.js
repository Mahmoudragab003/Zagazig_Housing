/**
 * Ø®Ø¯Ù…Ø© Google Gemini AI
 * Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©
 */

const { GoogleGenerativeAI } = require('@google/generative-ai');

// ØªÙ‡ÙŠØ¦Ø© Gemini
let genAI = null;
let model = null;

const initializeGemini = () => {
    if (!process.env.GEMINI_API_KEY) {
        console.log('âš ï¸ GEMINI_API_KEY not found - using local AI fallback');
        return false;
    }

    try {
        genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
        model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });
        console.log('âœ… Gemini AI initialized successfully');
        return true;
    } catch (error) {
        console.error('âŒ Error initializing Gemini:', error.message);
        return false;
    }
};

/**
 * ØªØ­Ù„ÙŠÙ„ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù„ÙÙ„Ø§ØªØ±
 */
const parseSearchQuery = async (query) => {
    if (!model) {
        return null; // fallback to local parsing
    }

    try {
        const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù„Ù…ÙˆÙ‚Ø¹ "Ø³ÙƒÙ† Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚" Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ù‚Ù‚ Ù„Ù„Ø·Ù„Ø§Ø¨.

Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø£Ù„: "${query}"

Ø­Ù„Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«. Ø£Ø±Ø¬Ø¹ JSON ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ:

{
    "type": "rent" Ø£Ùˆ "sell" Ø£Ùˆ null (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ°ÙƒØ±),
    "district": "Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©" Ø£Ùˆ null,
    "maxPrice": Ø±Ù‚Ù… Ø£Ùˆ null,
    "minPrice": Ø±Ù‚Ù… Ø£Ùˆ null,
    "bedrooms": Ø±Ù‚Ù… Ø£Ùˆ null,
    "furnished": true/false Ø£Ùˆ null,
    "nearCampus": true/false Ø£Ùˆ null,
    "understanding": "Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ØªÙˆØ¶Ø­ ÙÙ‡Ù…Ùƒ Ù„Ù„Ø³Ø¤Ø§Ù„"
}

Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
- "Ø¥ÙŠØ¬Ø§Ø±/Ø£Ø¬Ø§Ø±/rent" = type: "rent"
- "Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡/sell" = type: "sell"
- Ø£ÙŠ Ø±Ù‚Ù… Ù…Ø¹ "Ø¬Ù†ÙŠÙ‡" Ø£Ùˆ "Ø¬.Ù…" = Ø³Ø¹Ø±
- "Ù…ÙØ±ÙˆØ´/ÙØ±Ø´" = furnished: true
- "Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©/ÙƒÙ„ÙŠØ©" = nearCampus: true`;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        const text = response.text();

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ JSON Ù…Ù† Ø§Ù„Ø±Ø¯
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            const parsed = JSON.parse(jsonMatch[0]);
            return {
                filters: {
                    type: parsed.type || null,
                    district: parsed.district || null,
                    maxPrice: parsed.maxPrice || null,
                    minPrice: parsed.minPrice || null,
                    bedrooms: parsed.bedrooms || null,
                    furnished: parsed.furnished || null,
                    nearCampus: parsed.nearCampus || null
                },
                understanding: parsed.understanding || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...'
            };
        }
        return null;
    } catch (error) {
        console.error('Gemini parsing error:', error.message);
        return null;
    }
};

/**
 * ØªÙˆÙ„ÙŠØ¯ Ø±Ø¯ Ø°ÙƒÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„
 */
const generateSmartReply = async (query, resultsCount, listings = []) => {
    if (!model) {
        return null; // fallback to local response
    }

    try {
        let listingSummary = '';
        if (listings.length > 0) {
            listingSummary = listings.slice(0, 3).map(l =>
                `- ${l.title}: ${l.price} Ø¬Ù†ÙŠÙ‡ØŒ ${l.bedrooms} ØºØ±ÙØŒ ${l.address?.district || 'Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚'}`
            ).join('\n');
        }

        const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ÙˆØ¯ÙˆØ¯ Ù„Ù…ÙˆÙ‚Ø¹ "Ø³ÙƒÙ† Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚" Ù„Ù„Ø´Ù‚Ù‚ Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ©.

Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø£Ù„: "${query}"
Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${resultsCount}
${listingSummary ? `Ø£Ù…Ø«Ù„Ø© Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬:\n${listingSummary}` : ''}

Ø§ÙƒØªØ¨ Ø±Ø¯ Ù‚ØµÙŠØ± ÙˆÙˆØ¯ÙˆØ¯ (Ø¬Ù…Ù„ØªÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰) Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©. 
- Ù„Ùˆ ÙÙŠÙ‡ Ù†ØªØ§Ø¦Ø¬: Ø§Ø°ÙƒØ± Ø§Ù„Ø¹Ø¯Ø¯ ÙˆØ´Ø¬Ø¹Ù‡ ÙŠØªØµÙØ­
- Ù„Ùˆ Ù…ÙÙŠØ´: Ø§Ù‚ØªØ±Ø­ ÙŠÙˆØ³Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ ÙŠØ­ÙØ¸Ù‡ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
- Ø§Ø³ØªØ®Ø¯Ù… Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙˆØ§Ø­Ø¯ Ù…Ù†Ø§Ø³Ø¨`;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        return response.text().trim();
    } catch (error) {
        console.error('Gemini reply error:', error.message);
        return null;
    }
};

/**
 * Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø¹Ø§Ù…Ø© ÙˆÙ…Ø­Ø§Ø¯Ø«Ø§Øª
 */
const answerGeneralQuestion = async (query) => {
    if (!model) {
        return null;
    }

    try {
        const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ÙˆØ¯ÙˆØ¯ ÙˆØ°ÙƒÙŠ Ø¬Ø¯Ø§Ù‹ ÙˆØ§Ø³Ù…Ùƒ "Ù…Ø³Ø§Ø¹Ø¯ Ø³ÙƒÙ† Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚" ðŸ 

Ø£Ù†Øª Ø´Ø§Øª Ø¨ÙˆØª Ø°ÙƒÙŠ ÙˆÙˆØ¯ÙˆØ¯ ÙˆÙ…ØªØ¹Ø§ÙˆÙ† Ù„Ù…ÙˆÙ‚Ø¹ "Ø³ÙƒÙ† Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚" - Ù…Ù†ØµØ© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ù‚Ù‚ ÙˆØ³ÙƒÙ† Ø·Ù„Ø§Ø¨ÙŠ Ø¨Ø§Ù„Ù‚Ø±Ø¨ Ù…Ù† Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚ ÙÙŠ Ù…ØµØ±.

Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ù„: "${query}"

ðŸŽ¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
1. Ø±Ø¯ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„ÙˆØ¯ÙˆØ¯Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
2. Ø§Ø³ØªØ®Ø¯Ù… Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù…Ù†Ø§Ø³Ø¨ (1-2 ÙÙ‚Ø·)
3. Ø§Ù„Ø±Ø¯ ÙŠÙƒÙˆÙ† Ù‚ØµÙŠØ± ÙˆØ·Ø¨ÙŠØ¹ÙŠ (Ø¬Ù…Ù„Ø© Ø£Ùˆ Ø¬Ù…Ù„ØªÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
4. ÙƒÙ† Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙ„Ø·ÙŠÙ Ø²ÙŠ ØµØ§Ø­Ø¨ Ø¨ÙŠØ³Ø§Ø¹Ø¯ ØµØ§Ø­Ø¨Ù‡

ðŸ“‹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:

ðŸ™ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±:
- "Ø´ÙƒØ±Ø§Ù‹/Ù…Ø±Ø³ÙŠ/thank" â†’ "Ø§Ù„Ø¹ÙÙˆ ÙŠØ§ ØµØ§Ø­Ø¨ÙŠ! ðŸ˜Š Ù„Ùˆ Ù…Ø­ØªØ§Ø¬ Ø­Ø§Ø¬Ø© ØªØ§Ù†ÙŠØ© Ù‚ÙˆÙ„ÙŠ"
- "Ø±Ø¨Ù†Ø§ ÙŠØ®Ù„ÙŠÙƒ/Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡" â†’ "Ø¢Ù…ÙŠÙ† ÙŠØ§Ø±Ø¨! ðŸŒŸ Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ùˆ Ø§Ø­ØªØ¬Øª Ù…Ø³Ø§Ø¹Ø¯Ø©"

ðŸ‘‹ Ø§Ù„ØªØ­ÙŠØ§Øª:
- "Ù…Ø±Ø­Ø¨Ø§/Ø£Ù‡Ù„Ø§Ù‹/Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…/Ù‡Ø§ÙŠ/Ø§Ø²ÙŠÙƒ" â†’ Ø±Ø­Ø¨ Ø¨ÙŠÙ‡ Ø¨Ø­Ø±Ø§Ø±Ø© ÙˆØ§Ø³Ø£Ù„Ù‡ Ø¨ÙŠØ¯ÙˆØ± Ø¹Ù„Ù‰ Ø¥ÙŠÙ‡
- "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±/Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±" â†’ Ø±Ø¯ Ø§Ù„ØªØ­ÙŠØ© ÙˆØ§Ø³Ø£Ù„Ù‡ Ù…Ø­ØªØ§Ø¬ Ø´Ù‚Ø©ØŸ
- "Ø¨Ø§ÙŠ/Ù…Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ø©" â†’ ÙˆØ¯Ø¹Ù‡ Ø¨Ù„Ø·Ù ÙˆÙ‚ÙˆÙ„Ù‡ Ø§Ø±Ø¬Ø¹ Ù„Ùˆ Ø§Ø­ØªØ¬Øª Ø­Ø§Ø¬Ø©

â“ Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ø¨ÙˆØª:
- "Ø§Ø³Ù…Ùƒ Ø§ÙŠÙ‡/Ø§Ù†Øª Ù…ÙŠÙ†" â†’ "Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø³ÙƒÙ† Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚ ðŸ  Ø¨Ø³Ø§Ø¹Ø¯Ùƒ ØªÙ„Ø§Ù‚ÙŠ Ø´Ù‚Ø© Ø­Ù„ÙˆØ©!"
- "Ø§Ù†Øª Ø±ÙˆØ¨ÙˆØª/Ø¨ÙˆØª/Ø¢Ù„Ø©" â†’ "Ø£ÙŠÙˆÙ‡ Ø£Ù†Ø§ Ø¨ÙˆØª Ø°ÙƒÙŠ ðŸ¤– Ø¨Ø³ Ø¨Ø­Ø§ÙˆÙ„ Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø²ÙŠ Ø§Ù„Ø¨Ù†ÙŠ Ø¢Ø¯Ù…ÙŠÙ†!"
- "Ø§Ù†Øª Ø´Ø§Ø·Ø±/Ø°ÙƒÙŠ" â†’ Ø§Ø´ÙƒØ±Ù‡ Ø¨ØªÙˆØ§Ø¶Ø¹
- "Ø¨ØªØ¹Ù…Ù„ Ø§ÙŠÙ‡/Ù…Ù…ÙƒÙ† ØªØ³Ø§Ø¹Ø¯Ù†ÙŠ Ø§Ø²Ø§ÙŠ" â†’ Ø§Ø´Ø±Ø­Ù„Ù‡ Ø§Ù†Ùƒ Ø¨ØªØ³Ø§Ø¹Ø¯Ù‡ ÙŠÙ„Ø§Ù‚ÙŠ Ø´Ù‚Ø©

ðŸ’¬ Ø±Ø¯ÙˆØ¯ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©:
- "ØªÙ…Ø§Ù…/Ø­Ù„Ùˆ/Ø²ÙŠ Ø§Ù„ÙÙ„/Ù…Ù…ØªØ§Ø²/Ø¬Ù…ÙŠÙ„/Ø¹Ø¸ÙŠÙ…/Good" â†’ "ØªÙ…Ø§Ù… ÙƒØ¯Ù‡! ðŸ‘ Ù„Ùˆ Ù…Ø­ØªØ§Ø¬ Ø­Ø§Ø¬Ø© ØªØ§Ù†ÙŠØ© Ù‚ÙˆÙ„ÙŠ"
- "Ø§ÙˆÙƒÙŠ/Ù…Ø§Ø´ÙŠ/Ø·Ø¨" â†’ "ØªÙ…Ø§Ù…! ðŸ˜Š Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø­Ø§Ø¬Ø© ØªØ§Ù†ÙŠØ©ØŸ"

ðŸŒŸ Ø§Ù„Ù…Ø¯Ø­ ÙˆØ§Ù„Ø¥Ø·Ø±Ø§Ø¡:
- "Ø´Ø§Ø·Ø±/Ø¨Ø±Ø§ÙÙˆ/Ø¹Ø§Ø´/Ø¬Ø§Ù…Ø¯/ÙƒÙˆÙŠØ³" â†’ Ø§Ø´ÙƒØ±Ù‡ Ø¨ØªÙˆØ§Ø¶Ø¹ ÙˆÙ‚ÙˆÙ„Ù‡ Ø¨ØªØ­Ø§ÙˆÙ„ ØªØ³Ø§Ø¹Ø¯Ù‡
- "Ø§Ù†Øª Ø£Ø­Ø³Ù† Ø¨ÙˆØª" â†’ "Ù…ÙŠØ±Ø³ÙŠ Ø£ÙˆÙŠ! ðŸ¥° Ø¨Ø­Ø§ÙˆÙ„ Ø£ÙƒÙˆÙ† Ù…ÙÙŠØ¯ Ù‚Ø¯ Ù…Ø§ Ø£Ù‚Ø¯Ø±"

ðŸ˜” Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ù…Ø´Ø§ÙƒÙ„:
- "Ù…Ø´ Ù„Ø§Ù‚ÙŠ/ØµØ¹Ø¨/Ù…ÙÙŠØ´" â†’ Ø´Ø¬Ø¹Ù‡ ÙˆÙ‚ÙˆÙ„Ù‡ Ø¬Ø±Ø¨ ÙŠÙˆØ³Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ ÙŠØ³Ø£Ù„ ØªØ§Ù†ÙŠ
- "ØºØ§Ù„ÙŠ/Ù…Ø´ Ù‚Ø§Ø¯Ø±" â†’ Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙ‡ ÙŠØ¬Ø±Ø¨ Ø£Ø³Ø¹Ø§Ø± Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ù…Ù†Ø§Ø·Ù‚ ØªØ§Ù†ÙŠØ©
- "Ù…Ø´ ÙØ§Ù‡Ù…" â†’ Ø§Ø´Ø±Ø­Ù„Ù‡ Ø¨Ø¨Ø³Ø§Ø·Ø© Ø§Ø²Ø§ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹

ðŸ“ Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø®Ø¯Ù…Ø©:
- "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨ØªØ§Ø¹ÙƒÙ… ÙÙŠÙ†/Ø§ÙŠÙ‡ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ù‡" â†’ Ø§Ø´Ø±Ø­Ù„Ù‡ Ø¥Ù† Ø¯Ù‡ Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³ÙƒÙ† Ø·Ù„Ø§Ø¨ÙŠ ÙÙŠ Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚
- "Ø¨ØªØ´ØªØºÙ„ÙˆØ§ Ø§Ø²Ø§ÙŠ/Ø§Ø²Ø§ÙŠ Ø£Ø¯ÙˆØ±" â†’ Ø§Ø´Ø±Ø­Ù„Ù‡ Ø¥Ù†Ù‡ ÙŠÙ‚ÙˆÙ„Ùƒ Ø¨ÙŠØ¯ÙˆØ± Ø¹Ù„Ù‰ Ø¥ÙŠÙ‡ ÙˆØ§Ù†Øª Ù‡ØªØ³Ø§Ø¹Ø¯Ù‡
- "ÙÙŠÙ‡ Ø´Ù‚Ù‚ ÙƒØªÙŠØ±ØŸ" â†’ Ù‚ÙˆÙ„Ù‡ Ø¥Ù† ÙÙŠÙ‡ Ø®ÙŠØ§Ø±Ø§Øª ÙƒØªÙŠØ± ÙˆÙŠÙ‚ÙˆÙ„Ùƒ Ø¨ÙŠØ¯ÙˆØ± Ø¹Ù„Ù‰ Ø¥ÙŠÙ‡

ðŸŽ“ Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©:
- "Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø²Ù‚Ø§Ø²ÙŠÙ‚ ÙÙŠÙ†/Ø¨Ø¹ÙŠØ¯" â†’ Ø§Ø´Ø±Ø­Ù„Ù‡ Ø¥Ù† ÙÙŠÙ‡ Ø´Ù‚Ù‚ Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©
- "Ø§Ù†Ù‡ÙŠ Ù…Ù†Ø·Ù‚Ø© Ø£Ø­Ø³Ù†" â†’ Ø§Ù‚ØªØ±Ø­ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©

ðŸ’° Ø£Ø³Ø¦Ù„Ø© Ø¹Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:
- "Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§ÙŠÙ‡/Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±" â†’ Ù‚ÙˆÙ„Ù‡ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨ØªØ®ØªÙ„Ù ÙˆÙ…Ù…ÙƒÙ† ÙŠÙ‚ÙˆÙ„Ùƒ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙ‡
- "Ø§ÙŠÙ‡ Ø£Ø±Ø®Øµ Ø´Ù‚Ø©" â†’ Ø§Ù‚ØªØ±Ø­ Ø¹Ù„ÙŠÙ‡ ÙŠØ¬Ø±Ø¨ ÙŠØ¯ÙˆØ± Ø¹Ù„Ù‰ Ø´Ù‚Ù‚ Ø¨Ø³Ø¹Ø± Ù…Ø¹ÙŠÙ†

ðŸ”§ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©:
- "Ù…Ø³Ø§Ø¹Ø¯Ø©/help/Ø§Ø²Ø§ÙŠ" â†’ Ø§Ø´Ø±Ø­Ù„Ù‡ Ø§Ø²Ø§ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø«
- "Ø¹Ø§ÙŠØ² Ø£ØªÙƒÙ„Ù… Ù…Ø¹ Ø­Ø¯" â†’ Ù‚ÙˆÙ„Ù‡ Ù…Ù…ÙƒÙ† ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹ ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ù‚Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†

ðŸ“ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø£Ø®Ø±Ù‰:
- Ø£ÙŠ Ø³Ø¤Ø§Ù„ ØºØ±ÙŠØ¨ â†’ Ø±Ø¯ Ø¨Ù„Ø·Ù ÙˆØ­ÙˆÙ„Ù‡ Ù„Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ù‚Ø©)
- ÙƒÙ„Ø§Ù… Ù…Ø´ ÙˆØ§Ø¶Ø­ â†’ Ø§Ø³Ø£Ù„Ù‡ ÙŠÙˆØ¶Ø­ Ø£ÙƒØªØ± Ø¨Ø£Ø¯Ø¨

âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:
- Ù…ØªØ¬Ø§ÙˆØ¨Ø´ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø³ÙŠØ§Ø³ÙŠØ© Ø£Ùˆ Ø¯ÙŠÙ†ÙŠØ© Ø­Ø³Ø§Ø³Ø©
- Ù„Ùˆ Ø­Ø¯ Ù‚Ø§Ù„ ÙƒÙ„Ø§Ù… Ø³ÙŠØ¡ Ø£Ùˆ Ø´ØªÙŠÙ…Ø© â†’ Ø±Ø¯ Ø¨Ù‡Ø¯ÙˆØ¡ ÙˆØ§Ù‚ØªØ±Ø­ ÙŠØ³Ø£Ù„ Ø¹Ù† Ø´Ù‚Ø©
- Ø¯Ø§ÙŠÙ…Ø§Ù‹ Ø®Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø³ÙƒÙ† ÙˆØ§Ù„Ø´Ù‚Ù‚

Ø±Ø¯ Ø§Ù„Ø¢Ù† Ø¨Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø¬Ù…Ù„ØªÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰:`;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        return response.text().trim();
    } catch (error) {
        console.error('Gemini answer error:', error.message);
        return null;
    }
};

/**
 * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Gemini Ù…ØªØ§Ø­
 */
const isGeminiAvailable = () => {
    return model !== null;
};

// ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
initializeGemini();

module.exports = {
    initializeGemini,
    parseSearchQuery,
    generateSmartReply,
    answerGeneralQuestion,
    isGeminiAvailable
};
